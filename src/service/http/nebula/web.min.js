import{NebulaClient}from"/dist/web/main.js";import{Charts}from"/c/charts.min.js";import{Constraints}from"/c/constraints.min.js";const ds=NebulaClient.d3.select,$$=e=>$(e).val();let json=[],newdata=!1,fpcs,fpce;const serviceAddr=`${window.location.protocol}//${window.location.hostname}:8080`,v1Client=new NebulaClient.V1Client(serviceAddr),timeCol="_time_",charts=new Charts,formatTime=charts.formatTime;let archMode=2,filters,$sdc=null;const onTableState=(state,stats,callback)=>{const bc=state.bc,rc=Math.round(state.rc/1e4)/100,ms=Math.round(state.ms/1e7)/100,mints=formatTime(1e3*state.mt),maxts=formatTime(1e3*state.xt+1);stats.text(`[Blocks: ${bc}, Rows: ${rc}M, Mem: ${ms}GB, Min T: ${mints}, Max T: ${maxts}]`),fpcs=$("#start").flatpickr({enableTime:!0,allowInput:!0,clickOpens:!1,dateFormat:"Y-m-d H:i:S",defaultDate:mints,minDate:mints,maxDate:maxts}),$("#startc").on("click",()=>{fpcs.open()}),fpce=$("#end").flatpickr({enableTime:!0,allowInput:!0,clickOpens:!1,dateFormat:"Y-m-d H:i:S",defaultDate:maxts,minDate:mints,maxDate:maxts}),$("#endc").on("click",()=>{fpce.open()});const dimensions=state.dl.filter(v=>v!==timeCol);let metrics=state.ml.filter(v=>v!==timeCol);const all=dimensions.concat(metrics);let rollups=Object.keys(NebulaClient.Rollup);$("#dwrapper").html('<select id="dcolumns" multiple></select>'),ds("#dcolumns").html("").selectAll("option").data(all).enter().append("option").text(d=>d).attr("value",d=>d),$sdc=$("#dcolumns").selectize({plugins:["restore_on_backspace","remove_button"],persist:!1}),0==metrics.length&&(metrics=[dimensions[0]],rollups=["COUNT"]),ds("#mcolumns").html("").selectAll("option").data(metrics).enter().append("option").text(d=>d).attr("value",d=>d),ds("#display").html("").selectAll("option").data(Object.keys(NebulaClient.DisplayType)).enter().append("option").text(k=>k.toLowerCase()).attr("value",k=>NebulaClient.DisplayType[k]),ds("#ru").html("").selectAll("option").data(rollups).enter().append("option").text(k=>k.toLowerCase()).attr("value",k=>NebulaClient.Rollup[k]),ds("#ob").html("").selectAll("option").data(Object.keys(NebulaClient.OrderType)).enter().append("option").text(k=>k.toLowerCase()).attr("value",k=>NebulaClient.OrderType[k]),callback&&callback(all)},initTable=(table,callback)=>{const stats=ds("#stats");if(1===archMode){const req=new NebulaClient.TableStateRequest;req.setTable(table),v1Client.state(req,{},(err,reply)=>{null!==err?stats.text("Error code: "+err):null==reply?stats.text("Failed to get reply"):onTableState({bc:reply.getBlockcount(),rc:reply.getRowcount(),ms:reply.getMemsize(),mt:reply.getMintime(),xt:reply.getMaxtime(),dl:reply.getDimensionList(),ml:reply.getMetricList()},stats,callback)})}else 2===archMode&&$.ajax({url:"/?api=state&start=0&end=0&table="+encodeURIComponent(table)}).fail(err=>{stats.text("Error: "+err)}).done(data=>{onTableState(data,stats,callback)})},checkRequest=()=>{const display=$$("#display");if(display==NebulaClient.DisplayType.TIMELINE){const windowSize=$$("#window");if(windowSize>0){const start=new Date($$("#start")).getTime(),end=new Date($$("#end")).getTime(),rangeSeconds=(end-start)/1e3,buckets=rangeSeconds/windowSize;if(buckets>1e3)return ds("#qr").text(`Too many data points to return ${buckets}, please increase window granularity.`),!0}}if(display==NebulaClient.DisplayType.SAMPLES){const dimensions=$$("#dcolumns");if(0==dimensions.length)return ds("#qr").text("Please specify dimensions for samples"),!0}return!1},hash=v=>(v&&(window.location.hash=v),window.location.hash),build=()=>{const Q={t:$$("#tables"),s:$$("#start"),e:$$("#end"),fv:$$("#fvalue"),fo:$$("#fop"),ff:filters.expr(),ds:$$("#dcolumns"),w:$$("#window"),d:$$("#display"),m:$$("#mcolumns"),r:$$("#ru"),o:$$("#ob"),l:$$("#limit")};Q.s&&Q.e?hash("#"+encodeURIComponent(JSON.stringify(Q))):alert("please enter start and end time")},restore=()=>{let h=hash();if(!h||h.length<10){console.log(`Bad URL: ${h}`);const tb=$$("#tables");h=`?{"t": "${tb}"}`}const p=JSON.parse(decodeURIComponent(h.substr(1))),set=(N,V)=>ds(N).property("value",V);p.t&&(set("#tables",p.t),initTable(p.t,cols=>{set("#start",p.s),set("#end",p.e),set("#window",p.w),set("#display",p.d),set("#mcolumns",p.m),set("#ru",p.r),set("#ob",p.o),set("#limit",p.l),$sdc&&p.ds&&$sdc[0].selectize.setValue(p.ds);const om={EQ:"=",NEQ:"!=",MORE:">",LESS:"<",LIKE:"like",ILIKE:"ilike"},ops={};for(var k in NebulaClient.Operation){let value;ops[NebulaClient.Operation[k]]=om[k]}filters=new Constraints(!1,"filters",cols,ops,p.ff),execute()}))},seconds=ds=>Math.round(new Date(ds).getTime()/1e3),extractXY=(json,q)=>{const dims=q.getDimensionList();let metric="";for(const key in json[0])dims.includes(key)||(metric=key);return{d:dims[0],m:metric}},buildRequest=queryStr=>{const p=JSON.parse(decodeURIComponent(queryStr));p.arch&&(archMode=parseInt(p.arch));const q=new NebulaClient.QueryRequest;if(q.setTable(p.t),q.setStart(seconds(p.s)),q.setEnd(seconds(p.e)),p.ff){const rules=p.ff.r;if(rules&&rules.length>0){const predicates=[];if($.each(rules,(i,r)=>{const pred=new NebulaClient.Predicate;r.v&&r.v.length>0&&(pred.setColumn(r.c),pred.setOp(r.o),pred.setValueList(r.v),predicates.push(pred))}),predicates.length>0)if("AND"===p.ff.l){const filter=new NebulaClient.PredicateAnd;filter.setExpressionList(predicates),q.setFiltera(filter)}else if("OR"===p.ff.l){const filter=new NebulaClient.PredicateOr;filter.setExpressionList(predicates),q.setFiltero(filter)}}}const dimensions=p.ds;if(p.d==NebulaClient.DisplayType.SAMPLES&&dimensions.unshift(timeCol),q.setDimensionList(dimensions),q.setDisplay(p.d),q.setWindow(p.w),p.d!=NebulaClient.DisplayType.SAMPLES){const m=new NebulaClient.Metric,mcol=p.m;m.setColumn(mcol),m.setMethod(p.r),q.setMetricList([m]);const o=new NebulaClient.Order;o.setColumn(mcol),o.setType(p.o),q.setOrder(o)}return q.setTop(p.l),q},onQueryResult=(q,r,msg)=>{if(r.error)return void msg.text(`[query: error=${r.error}, latency=${r.duration} ms]`);if(msg.html(`[query time: ${r.duration} ms]`),json=JSON.parse(NebulaClient.bytes2utf8(r.data)),newdata=!0,ds("#table_head").html(""),ds("#table_content").html(""),0==json.length)return void $("#show").html("<b>NO RESULTS.</b>");const draw=()=>{const display=+$$("#display"),keys=extractXY(json,q);switch(display){case NebulaClient.DisplayType.SAMPLES:case NebulaClient.DisplayType.TABLE:charts.displayTable(json);break;case NebulaClient.DisplayType.TIMELINE:const WINDOW_KEY="_window_",start=new Date($$("#start"));let data={default:json};if(keys.d&&keys.d.length>0){const groupBy=(list,key)=>list.reduce((rv,x)=>((rv[x[key]]=rv[x[key]]||[]).push(x),rv),{});data=groupBy(json,keys.d)}charts.displayTimeline(data,WINDOW_KEY,keys.m,+start);break;case NebulaClient.DisplayType.BAR:charts.displayBar(json,keys.d,keys.m);break;case NebulaClient.DisplayType.PIE:charts.displayPie(json,keys.d,keys.m);break;case NebulaClient.DisplayType.LINE:charts.displayLine(json,keys.d,keys.m)}};draw(),$(window).on("resize",draw)},execute=()=>{const h=hash();if(!h||h.length<=2)return;if(checkRequest())return;const msg=ds("#qr");msg.text("soaring in nebula to land...");const queryStr=h.substr(1),q=buildRequest(queryStr);1===archMode?v1Client.query(q,{},(err,reply)=>{if(null==reply||err)return void msg.text(`Failed to get reply: ${err}`);const stats=reply.getStats(),r={error:stats.getError(),duration:stats.getQuerytimems(),data:reply.getData()};onQueryResult(q,r,msg)}):2===archMode&&$.ajax({url:"/?api=query&start=0&end=0&query="+queryStr}).fail(err=>{msg.text("Error: "+err)}).done(data=>{onQueryResult(q,data,msg)})};ds("#btn").on("click",build),window.onhashchange=function(){execute()};const onTableList=tables=>{const options=ds("#tables").selectAll("option").data(tables.sort()).enter().append("option");options.text(d=>d).attr("value",d=>d),restore()};$(()=>{const stats=ds("#stats");if(1===archMode){const listReq=new NebulaClient.ListTables;listReq.setLimit(100),v1Client.tables(listReq,{},(err,reply)=>{null===err?onTableList(reply.getTableList()):stats.text(`RPC Error: ${err}`)})}else 2===archMode&&$.ajax({url:"/?api=tables&start=0&end=0"}).fail(err=>{stats.text("Error: "+err)}).done(data=>{onTableList(data)});ds("#tables").on("change",()=>{hash("n"),restore()}),$.ajax({url:"/?api=user"}).done(data=>{ds("#user").text(data.auth?data.user:"unauth")})});