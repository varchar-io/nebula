import{neb}from"./dist/web/main2.js";import{Nebula,count,sum,min,max,avg,tree,p10,p25,p50,p75,p90,p99,p99_9,p99_99,and,or,eq,neq,gt,lt,like,ilike,unlike,iunlike}from"./__/sdk.min.js";import{Constraints}from"../c/constraints.min.js";import{Charts}from"./c/charts2.min.js";const time=neb.time,$$=e=>$(e).val();let ds={keys:[],metrics:[],rows:[],orders:{}},tableInfo={},fpcs,fpce;const timeCol="_time_",windowCol="_window_",autoKey=e=>e==timeCol||e==windowCol,charts=new Charts,nebula=new Nebula,chartId="#show",fieldsId="fields",fieldsRef=`#${fieldsId}`,tablesId="#tables",startId="#start",endId="#end",windowId="#window",displayId="#display",NoRollup=-1,msg=e=>$("#qr").text(e),vis=(e,t)=>$(e).css("visibility",t?"visible":"hidden"),FETCH_OPT={method:"GET"};let filters,$sdc=null;const field=(e,t)=>{const s=t in neb.Rollup;return{M:s?neb.Rollup[t]:NoRollup,C:e,T:s?`${t.toLowerCase()}(${e})`:e}},makeCalendar=(e,t,s,i,r,n)=>{e=$(t).flatpickr({enableTime:!0,allowInput:!0,clickOpens:!1,dateFormat:"Y-m-d H:i:S",defaultDate:i,minDate:r,maxDate:n,allowInvalidPreload:!0}),$(s).on("click",(()=>{setTimeout((()=>{e.open()}),0)}))},onTableState=(e,t,s)=>{tableInfo=e;const i=e.bc,r=Math.round(e.rc/1e4)/100,n=Math.round(e.ms/1e7)/100,o=time.format(1e3*e.mt),a=time.format(1e3*e.xt+1);t.text(`[Blocks: ${i}, Rows: ${r}M, Mem: ${n}GB, Min UTC: ${o}, Max UTC: ${a}]`),makeCalendar(fpcs,startId,"#startc",o,o,a),makeCalendar(fpce,endId,"#endc",a,o,a);const l=(e.dl||[]).filter((e=>e!==timeCol)),c=(e.ml||[]).filter((e=>e!==timeCol)),d=l.concat(c),m=[];d.map((e=>m.push(field(e))));for(let e in neb.Rollup){if("COUNT"===e){m.push(field(m[0].C,e));continue}let t=c;"TREEMERGE"===e&&(t=l),"CARD_EST"===e&&(t=[...l,...c]),t.map((t=>m.push(field(t,e))))}$("#dwrapper").html(`<select id="${fieldsId}" multiple></select>`);const h=$(fieldsRef).html("");m.forEach((e=>{$("<option/>").appendTo(h).text(e.T).val(`${JSON.stringify(e)}`)})),$sdc=h.selectize({plugins:["restore_on_backspace","remove_button"],persist:!1}),$("#ob").html(""),Object.keys(neb.OrderType).forEach((e=>{$("<option/>").appendTo($("#ob")).text(e.toLowerCase()).val(neb.OrderType[e])})),s&&s(d)},initTable=(e,t)=>{const s=$("#stats");fetch(`/?api=state&start=0&end=0&table=${encodeURIComponent(e)}`,FETCH_OPT).then((e=>e.json())).then((e=>onTableState(e,s,t))).catch((e=>s.text("Error: "+e)))},checkRequest=e=>{if(e.metrics&&e.metrics.length>1)for(var t=0;t<e.metrics.length;t++)if(e.metrics[t].M==neb.Rollup.HIST)return msg("Please only select one hist in Fields"),!0;if(!e.start||!e.end)return!0;if(e.timeline){const t=e.window;if(t>0){const s=(e.end-e.start)/1e3/t;if(s>1e3)return msg(`Too many data points to return ${s}, please increase window granularity.`),!0}if(0==e.metrics.length)return msg("Timeline requires metric fields."),!0}return!1},hash=e=>(e&&(window.location.hash=e),window.location.hash),build=e=>{const t=[],s=[];if($$(fieldsRef).map((e=>{const i=JSON.parse(e);i.M===NoRollup?t.push(i.C):s.push(i)})),0==t.length&&0==s.length&&(t.push(...tableInfo.dl),t.push(...tableInfo.ml),t.sort()),s.length>0&&t.length>2)return void msg("Risk: too many keys to aggregate by.");0==s.length&&t.unshift(timeCol);let i=0,r=["3600","86400","604800","2592000","7889400","31536000"];for(let e=0;e<6;++e)$$(windowId)===r[e]&&(i=e+1);const n=e||{table:$$(tablesId),start:$$(startId),end:$$(endId),filter:filters.expr(),keys:t,timeline:$("#timeline").is(":checked"),window:$$(windowId),time_unit:i.toString(),metrics:s,sort:$$("#ob"),limit:$$("#limit")};n.start&&n.end?hash("#"+encodeURIComponent(JSON.stringify(n))):msg("Error: please enter start and end time")};let timer=null,timer2=null;const clsTimer=()=>{timer&&clearInterval(timer),timer2&&clearTimeout(timer2)},restore=()=>{clsTimer();const e=url2state(),t=(e,t)=>{t&&$(e).val(t)};let s=e.table,i=!1,r=null;$(`${tablesId} option`).each(((e,t)=>{r=r||t.value,t.value===s&&(i=!0)})),i||(timer=animate(`preparing table ${s} `),timer2=setTimeout((()=>{location.reload()}),3e3),s=r),s&&(t(tablesId,s),initTable(s,(s=>{t(startId,e.start),t(endId,e.end),$("#timeline").prop("checked",e.timeline),t(windowId,e.window),vis(windowId,e.timeline),t("#ob",e.sort),t("#limit",e.limit);const i=[];(e.keys||[]).map((e=>i.push(JSON.stringify(field(e))))),(e.metrics||[]).map((e=>i.push(JSON.stringify(e)))),$sdc&&i.length>0&&$sdc[0].selectize.setValue(i);const r={EQ:"=",NEQ:"!=",MORE:">",LESS:"<",LIKE:"like",ILIKE:"ilike",UNLIKE:"unlike",IUNLIKE:"iunlike"},n={};for(var o in neb.Operation)n[neb.Operation[o]]=r[o];filters=new Constraints(!1,"filters",s,n,e.filter),e.code&&e.code.length>0&&editor.getValue()!=e.code&&(editor.setValue(e.code),ide()),execute(e)})))},onQueryResult=(state,r)=>{if(r.error)return void msg(`[query: error=${r.error}, latency=${r.duration} ms]`);msg(`[query: latency=${r.duration}ms, scan=${r.rows_scan}, blocks=${r.blocks_scan}, rows=${r.rows_ret}]`),ds.timeline=state.timeline,ds.rows=JSON.parse(atob(r.data)),ds.keys=[...state.keys],ds.metrics=[];for(const e in ds.rows[0])ds.keys.includes(e)||autoKey(e)||ds.metrics.push(e);if(state.pivot){const e=state.pivot,t=ds.metrics[0],s={},i=ds.keys.filter((t=>t!=e));state.timeline&&i.push(windowCol);const r={},n=n=>{const o=[];let a={};i.forEach((e=>{const t=n[e];a[e]=t,o.push(`${t}`)}));const l=o.join("-");l in s?a=s[l]:s[l]=a;const c=n[e];r[c]=1,a[c]=n[t]};ds.rows.forEach(n);const o=[];for(const e in s){const t=s[e];for(const e in r)e in t||(t[e]=0);o.push(t)}ds.rows=o,ds.keys=i.filter((e=>e!=windowCol)),ds.metrics=Object.keys(r)}if(state.map&&state.map.length>0){const nmap=eval(state.map)();if(nmap&&"function"==typeof nmap){ds.rows.forEach(nmap);for(const e in ds.rows[0])autoKey(e)||ds.keys.includes(e)||ds.metrics.includes(e)||ds.metrics.push(e)}}if(state.rm&&state.rm.length>0){const e=ds.metrics.filter((e=>!state.rm.includes(e)));e.length<ds.metrics.length&&(ds.metrics=e)}if($("#table").html(""),$(displayId).hide(),0==ds.rows.length)return void $("#show").html("<b>NO RESULTS.</b>");const choices=e=>{const t=e||[];t.length>0?$(displayId).show():$(displayId).hide(),$(displayId).html(""),t.forEach((e=>$("<option/>").appendTo($(displayId)).text(e).val(e)))};ds.timeline?choices(["timeline","timeline-area","timeline-bar"]):1==state.metrics.length&&state.metrics[0].M==neb.Rollup.TREEMERGE?choices(["icicle","flame"]):1==state.metrics.length&&state.metrics[0].M==neb.Rollup.HIST?choices(["column","bar","none"]):state.metrics.length>0?choices(["column","bar","doughnut","pie","line","none"]):choices();const draw=()=>{$(chartId).html("");const e=[...ds.keys],t=[...ds.rows],s=[...ds.metrics];if(e.length>1){const s=" - ",i=e.join(s);t.forEach((t=>{t[i]=e.map((e=>t[e])).join(s)})),e.length=0,e.push(i)}const i=histJsonIdx(s);let r=null,n=!0;if(-1!=i){n=!1;const[e,r]=processHistJson(t,s,i);t.length=0,e.map((e=>t.push(e))),s.length=0,r.map((e=>s.push(e)))}const o=$(displayId).val(),a=1e3*time.seconds(state.start);switch(o){case"timeline":r=charts.displayTimeline(chartId,t,e,s,windowCol,a,0);break;case"timeline-area":r=charts.displayTimeline(chartId,t,e,s,windowCol,a,1);break;case"timeline-bar":r=charts.displayTimeline(chartId,t,e,s,windowCol,a,2);break;case"icicle":r=charts.displayFlame(chartId,t,e,s,!1),n=!1;break;case"flame":r=charts.displayFlame(chartId,t,e,s,!0),n=!1;break;case"column":r=charts.displayBar(chartId,t,e,s,!0,-1!=i);break;case"bar":r=charts.displayBar(chartId,t,e,s,!1,-1!=i);break;case"doughnut":r=charts.displayPie(chartId,t,e,s,!0);break;case"pie":r=charts.displayPie(chartId,t,e,s,!1);break;case"line":r=charts.displayLine(chartId,t,e,s);break;default:break}n&&($("#table").attr("class","fh300"),charts.displayTable("#table",ds.rows,[timeCol,windowCol,...ds.keys],ds.metrics),0!=s.length&&"none"!==o||$("#table").removeClass("fh300")),r&&msg(`Error: ${r}`)};draw();var resizeTimer=void 0;$(window).on("resize",(()=>{clearTimeout(resizeTimer),resizeTimer=setTimeout(draw,200)})),$(displayId).change(draw),window.n_sort=e=>{if(ds.timeline)return;const t="ASC",s=(ds.orders[e]||t)===t?"DESC":t;ds.orders[e]=s;const i=s===t?(e,t)=>e>t?1:-1:(e,t)=>e<t?1:-1;ds.metrics.includes(e)?ds.rows.sort(((t,s)=>i(+t[e],+s[e]))):ds.rows.sort(((t,s)=>i(t[e],s[e]))),draw()}},histJsonIdx=e=>{for(var t=0;t<e.length;t++)if(e[t].endsWith(".HIST"))return t;return-1},processHistJson=(e,t,s)=>{let i=[],r=[];for(var n=0;n<e.length;n++){let l={},c={};for(var o in e[n])if(o===t[s]){let t=JSON.parse(e[n][o]).b,s={},i=[];for(var a=0;a<t.length;a++){let e,r=t[a][2];e=0===a?"[min, "+t[a][1]+"]":a===t.length-1?"["+t[a][0]+", max]":"["+t[a][0]+", "+t[a][1]+"]",s[e]=r,i.push(e)}l[o]=s,c[o]=i}else l[o]=e[n][o];r.push(c),i.push(l)}return[i,r]},url2state=()=>{const e=decodeURIComponent((hash()||`#${$$(tablesId)}`).substr(1));let t={table:e};try{t=JSON.parse(e)}catch{}return t};let dots=0;const animate=(e,t)=>setInterval((()=>{dots=(dots+1)%50,msg(`${e}${".".repeat(dots)}`)}),t||200),execute=e=>{if(e||(e=url2state()),checkRequest(e))return;timer=animate("soaring in nebula ");const t=`/?api=query&start=0&end=0&query=${encodeURIComponent(JSON.stringify(e))}`;fetch(t,FETCH_OPT).then((e=>e.json())).then((t=>{clsTimer(),onQueryResult(e,t)})).catch((e=>{clsTimer(),msg(`Error: ${e}`)}))};$("#share").on("click",(()=>{const e=location.href.substr(location.origin.length);fetch("/?api=url",{method:"POST",headers:{"content-type":"application/json"},body:e}).then((e=>e.json())).then((e=>{e.code&&e.code.length>4&&msg(`[query url: ${location.origin}/n/${e.code}]`)})).catch((e=>{msg(`Error: ${e}`)}))}));const editor=CodeMirror.fromTextArea($("#code").get(0),{lineNumbers:!1,lineWrapping:!0,styleActiveLine:!0,matchBrackets:!0,mode:"javascript",theme:"dracula"}),ide=()=>{const e="tap-on",t="tap-off",s=$(".tap-on"),i=$(".tap-off");s.removeClass(e).addClass(t),i.removeClass(t).addClass(e),setTimeout((()=>editor.refresh()),5)},iside=()=>"tap-off"==$("#qc").attr("class"),exec=()=>{const code=editor.getValue();nebula.reset();try{eval(code)}catch(e){return void msg(`Code Error: ${e.message}`)}const error=nebula.validate();if(error)return void msg(`Validation Error: ${error}`);const state=nebula.build();state.code=code,build(state)};window.onhashchange=function(){restore()};const onTableList=e=>{if(e&&e.length>0)return e.sort().forEach((e=>$("<option/>").appendTo($(tablesId)).text(e).val(e))),void restore();msg("Nebula is down: can not fetch tables")};$((()=>{const e=$("#stats");fetch("/?api=tables&start=0&end=0",FETCH_OPT).then((e=>e.json())).then((e=>{onTableList(e)})).catch((t=>{e.text("Error: "+t)})),$(tablesId).change((()=>{hash($(tablesId).val()),restore()})),fetch("/?api=user",FETCH_OPT).then((e=>e.json())).then((e=>{$("#user").text(e.auth?e.user:"unauth")}))})),$("#exec").click((e=>{iside()?exec():build()})),$("#ui").on("click",ide),$("#timeline").click((function(){vis(windowId,$(this).is(":checked"))}));