import{Color}from"./color.min.js";export class Flame{constructor(id,json,reverse){const fontSize=16,font="1rem Segoe UI",paddingV=10,paddingH=5,frameH=20,ratio=devicePixelRatio||1;this.reverse=reverse||!1,this.canvas=document.getElementById(id),this.ctx=this.canvas.getContext("2d"),this.maxLevel=1;{const canvasWidth=this.canvas.offsetWidth;this.canvas.style.width=canvasWidth+"px",this.canvas.width=canvasWidth*ratio,this.ctx.font=font,this.ratio=ratio}const menuHeight=30,buttons=[{name:"[Reverse Focus]",coord:{x:0,y:0,w:100,h:30},handler:()=>{if(!this.selected||this.selected.name===this.stack.name)return void alert("No non-root node selected.");const focus={name:this.selected.name,value:0,children:[]},path=[{o:this.stack,i:0}],merge=(p,f)=>{console.log(`get a path: ${p[p.length-1].o.name} - depth: ${p.length}`);let index=p.length-1;f.value+=p[index].o.value;let last=f;for(;index-- >0;){const node=p[index].o;let existing=last.children.find(e=>e.name===node.name);existing||(existing={name:node.name,value:node.value,children:[]},last.children.push(existing)),last=existing}};let pop=!1;for(;path.length>0;){if(pop){const item=path.splice(path.length-1,1)[0];if(path.length>0){const parent=path[path.length-1].o,nextId=item.i+1;nextId<parent.children.length&&(path.push({o:parent.children[nextId],i:nextId}),pop=!1)}continue}const last=path[path.length-1].o;last.name!==this.selected.name?last.children&&0!==last.children.length?(path.push({o:last.children[0],i:0}),pop=!1):pop=!0:(merge(path,focus),pop=!0)}this.stack=focus,this.init(),this.paint()}},{name:"[Reset]",coord:{x:120,y:0,w:80,h:30},handler:()=>{this.reset()}}];this.updateH=height=>{this.canvas.style.height=height+"px",this.canvas.height=height*ratio,this.ctx.scale(ratio,ratio)},this.color=name=>{const offset=5;let type=0;if("all"==name)type=4;else{if(this.selected&&this.selected.name==name)return"#9370d8";name.endsWith("_[j]")||name.endsWith("_[i]")||name.endsWith("_[k]")?type=1:name.startsWith("java.")||name.startsWith("scala.")||name.startsWith("sun.")?type=2:(name.includes("::")||name.startsWith("-[")||name.startsWith("+["))&&(type=3)}return Color.get(type+5)},this.yp=c=>this.reverse?this.height-c.y-20:c.y,this.paintMenu=()=>{this.ctx.fillStyle="#091982",this.ctx.fillRect(5,0,this.canvas.offsetWidth-10,30),this.ctx.fillStyle="#FFFFFF",this.ctx.font=font,buttons.forEach(e=>{this.ctx.fillText(e.name,e.coord.x+10,20,e.width)})},this.draw=frame=>{const name=frame.name||"all",width=frame.width,c=frame.coord;if(c.x<this.canvas.offsetWidth&&width>1){const y=this.yp(c);if(this.ctx.fillStyle=this.color(name),this.ctx.fillRect(c.x,y,width,20),width>=21){const chars=Math.floor(width/7),title=name.length<=chars?name:name.substring(0,chars-2)+"..";this.ctx.fillStyle="#000000",this.ctx.font=font,this.ctx.fillText(title,c.x+3,y+16,width-6)}}},this.touch=(frame,show)=>{frame.show=show;const children=frame.children||[],level=frame.level+1;return show&&level>this.maxLevel&&(this.maxLevel=level),children.forEach(c=>{c.show=show,c.parent=frame,c.level=level}),children},this.mark=(frame,root)=>{if(root){const queue=[...this.touch(frame,!1)];for(;queue.length>0;){if(queue.includes(root)){let p=root;for(;p;)p.show=!0,p=p.parent;break}queue.push(...this.touch(queue.shift(),!1))}}const queue=[];for(queue.push(...this.touch(root||frame,!0));queue.length>0;)queue.push(...this.touch(queue.shift(),!0))},this.visit=frame=>{if(!frame.show)return;this.draw(frame);const childY=frame.coord.y+20+2,children=(frame.children||[]).filter(e=>e.show),total=children.reduce((a,b)=>a+b.value,0);let lastX=frame.coord.x;const endX=lastX+frame.width;children.forEach(c=>{const pct=c.value/total;c.width=Math.floor(pct*frame.width);const overflow=lastX+c.width-endX;overflow>0&&(c.width-=overflow),c.coord={x:lastX,y:childY},lastX+=c.width+1,this.visit(c)})},this.paint=root=>{this.selected=root,this.maxLevel=0,this.mark(this.stack,root),this.height=20*(this.maxLevel+1)+30,root||this.updateH(this.height),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight),this.paintMenu(),this.visit(this.stack,root)},this.init=()=>{this.stack.width=this.canvas.offsetWidth-10,this.stack.level=0,this.stack.coord={x:5,y:40}},this.reset=()=>{this.stack=JSON.parse(json),this.init(),this.paint()},this.reset(),this.find=(frame,coord)=>{const c=frame.coord,y=this.yp(c);if(frame.show&&coord.y>=y&&coord.y<=y+20&&coord.x>=c.x&&coord.x<=c.x+frame.width)return frame;const children=frame.children||[];for(let i=0;i<children.length;++i){const found=this.find(children[i],coord);if(found)return found}return null},this.canvas.onmousemove=event=>{const c=this.canvas,point={x:event.pageX-c.offsetLeft,y:event.pageY-c.offsetTop},frame=this.find(this.stack,point);if(frame){c.style.cursor="pointer";const pct=(100*frame.width/this.stack.width).toPrecision(3);return c.title=`name: ${frame.name}, value: ${frame.value}, ratio: ${pct}%`,void(c.onclick=()=>{this.paint(frame)})}if(point.y<30){const btn=buttons.find(b=>point.x>=b.coord.x&&point.x<b.coord.x+b.coord.w);if(btn)return c.style.cursor="pointer",c.title=`click action: ${btn.name}`,void(c.onclick=()=>{btn.handler()})}this.canvas.onmouseout()},this.canvas.onmouseout=()=>{const c=this.canvas;c.title="",c.style.cursor="",c.onclick=""}}}